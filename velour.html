<!doctype html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NRKZ8X27FR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NRKZ8X27FR');
</script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Guest Perks</title>
  <style>
    :root {
      --bg: #0b0b0e;
      --card: #14141a;
      --muted: rgba(255,255,255,0.65);
      --text: #e8e8ea;
      --brand: #bfa37a;
      --accent: #2a2a35;
      --chip: #191922;
      --chip-border: #2a2a36;
      --border: #23232e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1200px 800px at 70% -10%, #1b1b22 0%, #0b0b0e 60%);
    }
    a { color: inherit; }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    header {
      padding: 8px 0 0;
      margin-bottom: 28px;
    }
    .header-top {
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }
    .brandline { display: flex; align-items: center; gap: 12px; }
    .logo { display: flex; align-items: center; gap: 2px; height: 36px; margin-right: 1px; }
    .logo img { height: 36px; width: auto; }
    .logo-badge { width: 36px; height: 36px; border-radius: 9px; background: linear-gradient(135deg,#1f1f29,#343445); display: grid; place-items: center; border: 1px solid #2e2e3a; font-size: 14px; }
    .tagline { color: var(--muted); font-weight: 500; letter-spacing: .02em; font-size: 1.25rem; }
    
    /* Level Status Display */
    .level-status {
      background: linear-gradient(135deg, var(--chip), var(--accent));
      border: 1px solid var(--chip-border);
      border-radius: 12px;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.05em;
    }
    .level-icon {
      font-size: 1.1rem;
    }
    .level-progress {
      margin-left: 8px;
      font-size: 0.8rem;
      color: var(--muted);
      font-weight: 400;
    }
    
    nav { 
      display: none; 
      gap: 8px; 
      flex-wrap: wrap;
      padding: 0;
      margin: 0;
    }
    body.authed nav { display: flex; }
    nav button { 
      background: transparent; 
      color: var(--text); 
      border: 1px solid #2b2b36; 
      padding: 10px 14px; 
      border-radius: 10px; 
      cursor: pointer;
      font-size: 0.9rem;
    }
    nav button:hover { background: #171722; }
    nav button.active {
      background: var(--brand);
      color: #0b0b0e;
      border-color: var(--brand);
      font-weight: 600;
    }
    
    .grid { display: grid; gap: 16px; }
    .grid.cols-3 { grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 18px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
    .muted { color: var(--muted); }
    .pill { display: inline-flex; align-items: center; gap: 8px; background: var(--chip); border: 1px solid var(--chip-border); padding: 6px 10px; border-radius: 999px; font-size: .9rem; }
    .code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; letter-spacing: .06em; }
    .small { font-size: .9rem; }
    section[hidden] { display: none !important; }
    .hero { background: linear-gradient(180deg, rgba(191,163,122,.08), transparent 55%); border: 1px solid #2a2a34; border-radius: 18px; padding: 20px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    input[type="text"], input[type="email"], select {
      background: #14141a; border: 1px solid #2a2a35; color: #fff; padding: 10px 12px; border-radius: 10px;
    }
    .offer { cursor: pointer; position: relative; }
    .offer .brand { letter-spacing: .08em; font-weight: 600; color: #d8d8db; }
    .offer .value { color: #bfa37a; font-weight: 700; }
    .offer .source-chip { position: absolute; top: 12px; right: 12px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: linear-gradient(180deg,#232330,#181822); color: #fff; border: 1px solid #2c2c3a; padding: 10px 14px; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
    .btn.primary { background: linear-gradient(180deg,#bfa37a,#9f835a); color: #0b0b0e; border-color: #bc9a67; font-weight: 600; }
    .btn.ghost { background: transparent; border-color: #2b2b36; }
    .btn:disabled { 
      opacity: 0.5 !important; 
      cursor: not-allowed !important; 
      pointer-events: none;
      background: #2a2a35 !important;
      color: #666 !important;
      border-color: #333 !important;
    }
    .btn.primary:disabled {
      background: #4a4a50 !important;
      color: #888 !important;
    }
    .divider { height: 1px; background: #232332; margin: 12px 0; }
    .modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.55); padding: 24px; }
    .modal[aria-hidden="false"] { display: grid; }
    .modal .sheet { max-width: 720px; width: 100%; background: #121218; border: 1px solid #2b2b37; border-radius: 16px; padding: 18px; }
    .modal header { padding: 0 0 8px; display: flex; justify-content: space-between; align-items: center; }
    .close { background: transparent; border: 1px solid #2d2d3a; color: #fff; border-radius: 10px; padding: 6px 10px; cursor: pointer; }
    .foot { display: flex; justify-content: flex-end; gap: 10px; margin-top: 12px; }
    .empty { text-align: center; padding: 28px 8px; color: var(--muted); }
    
    /* Level Progress Bar */
    .level-progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin: 8px 0;
    }
    .level-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), #d4af7a);
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    .level-text {
      font-size: 0.8rem;
      color: var(--muted);
      text-align: center;
    }

    @media (max-width: 768px) {
      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      nav {
        width: 100%;
        justify-content: flex-start;
      }
      .level-status {
        order: -1;
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-top">
        <div class="brandline">
          <div class="logo">
            <img src="images/velourlogo.png" alt="Velour Logo" class="site-logo">
          </div>
        </div>
      </div>
      <nav id="main-nav">
        <button type="button" onclick="App.showScreen('dashboard')" data-screen="dashboard">Dashboard</button>
        <button type="button" onclick="App.showScreen('messages')" data-screen="messages">Messages</button>
        <button type="button" onclick="App.showScreen('account')" data-screen="account">Account</button>
        <button type="button" onclick="App.openLevels()">Levels</button>
      </nav>
    </header>

    <!-- WELCOME (Access Landing) -->
    <section id="welcome-screen" class="grid" style="grid-template-columns: 1fr;">
      <div class="hero card">
        <h1 style="margin:0 0 8px;">Access Your Perks</h1>
        <p class="muted">Enter your email and Access code from your card to unlock your hotel's offers. You can add codes from multiple hotels later.</p>
        <form id="registration-form" style="margin-top:16px;">
          <div class="grid" style="grid-template-columns: 1fr 1fr;">
            <div>
              <label for="email">Email</label>
              <input type="email" id="email" placeholder="you@example.com" autocomplete="email" required>
            </div>
            <div>
              <label for="accesscode">Access code</label>
              <input type="text" id="accesscode" placeholder="enter: 12345" required>
            </div>
          </div>
          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="access-btn" class="btn primary" type="submit" disabled>Access Perks</button>
            <button class="btn ghost" type="button" onclick="App.openLevels()">How Levels Work</button>
          </div>
        </form>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard-screen" hidden>
      <div class="card">
        <h3 style="margin: 0 0 16px;">Your Level Progress</h3>
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
          <div class="pill">
            <span id="dashboard-level-icon">ðŸ¥‡</span>
            <span id="dashboard-level-name">GOLD</span>
          </div>
          <div style="flex: 1;">
            <div class="level-progress-bar">
              <div class="level-progress-fill" id="dashboard-progress-fill" style="width: 0%;"></div>
            </div>
            <div class="level-text" id="dashboard-progress-text">0 of 5 redemptions to reach PLATINUM</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="controls">
          <div class="pill">Offers Source</div>
          <select id="hotel-filter" onchange="App.renderOffers()"></select>
          <div class="pill">Add Hotel Code</div>
          <input id="add-code" type="text" placeholder="e.g., HILTON-ABC12" style="max-width:260px;">
          <button class="btn" type="button" onclick="App.addHotelFromCode()">Add</button>
        </div>
      </div>
      <div class="grid cols-3" id="offers-grid" style="margin-top:16px;"></div>
      <div id="no-offers" class="card empty" hidden>No offers yet. Add a hotel code to load perks from that property.</div>
    </section>

    <!-- ACCOUNT -->
    <section id="account-screen" hidden>
      <div class="grid cols-3">
        <div class="card">
          <h3 style="margin:0 0 8px;">Profile</h3>
          <div class="muted small">Email</div>
          <div id="profile-email">guest@email.com</div>
          <div class="divider"></div>
          <div class="muted small">Current Level</div>
          <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
            <span id="profile-level-icon">ðŸ¥‡</span>
            <span id="profile-level-name">GOLD</span>
          </div>
          <div class="divider"></div>
          <div class="muted small">Access Codes</div>
          <div id="profile-codes" class="small code">â€”</div>
          <div class="divider"></div>
          <button class="btn" type="button" onclick="App.openAccountDetail('profile')">Edit</button>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px;">History</h3>
          <div class="muted small">Total Redemptions</div>
          <div id="total-redemptions">0</div>
          <div class="divider"></div>
          <div class="muted small">Level Progress</div>
          <div style="margin: 8px 0;">
            <div class="level-progress-bar">
              <div class="level-progress-fill" id="account-progress-fill" style="width: 0%;"></div>
            </div>
            <div class="level-text" id="account-progress-text">0 of 5 redemptions to reach PLATINUM</div>
          </div>
          <div class="divider"></div>
          <button class="btn" type="button" onclick="App.openAccountDetail('history')">View</button>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px;">Preferences</h3>
          <div class="muted small">Notifications</div>
          <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn">New Offers â€¢ On</button>
            <button class="btn">Expirations â€¢ On</button>
            <button class="btn">Concierge â€¢ On</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MESSAGES -->
    <section id="messages-screen" hidden>
      <div class="grid cols-3">
        <div class="card">
          <h3 style="margin:0 0 8px;">Inbox</h3>
          <div class="grid">
            <button class="btn" onclick="App.openMessage('new-offers')">Concierge â€¢ New exclusive offers</button>
            <button class="btn" onclick="App.openMessage('ritz-carlton')">The Ritz-Carlton â€¢ Welcome</button>
            <button class="btn" onclick="App.openMessage('spa-reminder')">Spa Experience â€¢ Credit reminder</button>
            <button class="btn" onclick="App.openMessage('tesla-update')">Tesla â€¢ Your Model S is ready</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Offer Modal -->
  <div id="offer-modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Offer</strong>
        <button class="close" type="button" aria-label="Close" onclick="App.closeOffer()">Close</button>
      </header>
      <div class="divider"></div>
      <div id="modal-content-body"></div>
    </div>
  </div>

  <!-- Levels Modal -->
  <div id="levels-modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Guest Levels</strong>
        <button class="close" type="button" aria-label="Close" onclick="App.closeLevels()">Close</button>
      </header>
      <div class="divider"></div>
      <div id="levels-body">
        <p class="muted">Earn higher status by redeeming offers. Each redemption counts toward your progress.</p>
        <div class="grid">
          <div class="card">
            <div class="pill">ðŸ¥‡ GOLD</div>
            <div class="small muted" style="margin-top:8px;">0â€“4 redemptions</div>
            <div class="small muted">Starting level for all guests</div>
          </div>
          <div class="card">
            <div class="pill">ðŸ’Ž PLATINUM</div>
            <div class="small muted" style="margin-top:8px;">5â€“9 redemptions</div>
            <div class="small muted">Priority support & exclusive offers</div>
          </div>
          <div class="card">
            <div class="pill">â—† BLACK</div>
            <div class="small muted" style="margin-top:8px;">10â€“19 redemptions</div>
            <div class="small muted">VIP treatment & early access</div>
          </div>
          <div class="card">
            <div class="pill">ðŸ’  ELITE</div>
            <div class="small muted" style="margin-top:8px;">20â€“34 redemptions</div>
            <div class="small muted">Concierge services & premium perks</div>
          </div>
          <div class="card">
            <div class="pill">ðŸ’Ž DIAMOND</div>
            <div class="small muted" style="margin-top:8px;">35+ redemptions</div>
            <div class="small muted">Maximum tier with all benefits</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Detail Modal -->
  <div id="account-detail-modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Account</strong>
        <button class="close" type="button" aria-label="Close" onclick="App.closeAccountDetail()">Close</button>
      </header>
      <div class="divider"></div>
      <div id="account-detail-body"></div>
    </div>
  </div>

  <!-- Message Modal -->
  <div id="message-modal" class="modal" aria-hidden="true">
    <div class="sheet">
      <header>
        <strong>Message</strong>
        <button class="close" type="button" aria-label="Close" onclick="App.closeMessage()">Close</button>
      </header>
      <div class="divider"></div>
      <div id="message-content-body"></div>
    </div>
  </div>

  <script>
    const App = (() => {
      "use strict";
      const state = {
        authed: false,
        totalRedemptions: 0,
        scannedHotels: new Set(),
        availableHotels: new Set(),
        email: null,
        codes: [],  // access codes tied to this session
        currentLevel: 'GOLD',
        currentScreen: 'welcome'
      };

      // Level system
      const levels = {
        'GOLD': { min: 0, max: 4, icon: 'ðŸ¥‡', next: 'PLATINUM' },
        'PLATINUM': { min: 5, max: 9, icon: 'ðŸ’Ž', next: 'BLACK' },
        'BLACK': { min: 10, max: 19, icon: 'â—†', next: 'ELITE' },
        'ELITE': { min: 20, max: 34, icon: 'ðŸ’ ', next: 'DIAMOND' },
        'DIAMOND': { min: 35, max: 999, icon: 'ðŸ’Ž', next: null }
      };

      // Demo catalog
      const catalog = [
        { id:"tiffany", brand:"TIFFANY & CO.", value:"20% OFF", description:"Exclusive jewelry discount.", type:"in-store", redemption:"Present in-store.", hotel:"Marriott" },
        { id:"tesla", brand:"TESLA", value:"COMPLIMENTARY", description:"3-day Model S experience.", type:"qr", redemption:"Scan to book.", hotel:"Marriott", qrData:"https://example.com/tesla" },
        { id:"nobu", brand:"NOBU", value:"VIP ACCESS", description:"Priority omakase seating.", type:"email", redemption:"Enter email to reserve.", hotel:"Hilton" },
        { id:"spa", brand:"RITZ SPA", value:"$200 CREDIT", description:"Luxury spa treatment credit.", type:"in-store", redemption:"Show at desk.", hotel:"Ritz-Carlton" },
        { id:"rolex", brand:"ROLEX", value:"PRIVATE VIEWING", description:"Invitation-only boutique preview.", type:"email", redemption:"Enter email for invite.", hotel:"Hilton" }
      ];

      // Demo messages
      const messages = {
        "new-offers": { sender:"CONCIERGE", time:"2 MIN AGO", subject:"New Exclusive Offers Available", content:`<p>New VIP offers are live.</p>` },
        "ritz-carlton": { sender:"THE RITZ-CARLTON", time:"15 MIN AGO", subject:"Welcome to The Ritz-Carlton", content:`<p>Welcome to your stay.</p>` },
        "spa-reminder": { sender:"SPA EXPERIENCE", time:"2 HOURS AGO", subject:"Spa Credit Reminder", content:`<p>Your spa credit expires in 48 hours.</p>` },
        "tesla-update": { sender:"TESLA EXPERIENCE", time:"YESTERDAY", subject:"Your Model S is Ready", content:`<p>Your complimentary Tesla is ready.</p>` }
      };

      const $  = (s) => document.querySelector(s);
      const $$ = (s) => Array.from(document.querySelectorAll(s));

      

      function getCurrentLevel(redemptions) {
        for (const [levelName, levelData] of Object.entries(levels)) {
          if (redemptions >= levelData.min && redemptions <= levelData.max) {
            return levelName;
          }
        }
        return 'GOLD';
      }

      function updateLevelDisplay() {
        const currentLevel = getCurrentLevel(state.totalRedemptions);
        const levelData = levels[currentLevel];
        
        // Update header level display
        const levelDisplay = document.getElementById('level-display');
        const levelIcon = document.getElementById('level-icon');
        const levelName = document.getElementById('level-name');
        const levelProgress = document.getElementById('level-progress');
        
        if (levelDisplay && state.authed) {
          levelDisplay.style.display = 'flex';
          if (levelIcon) levelIcon.textContent = levelData.icon;
          if (levelName) levelName.textContent = currentLevel;
          
          if (levelData.next) {
            const nextLevel = levels[levelData.next];
            const needed = nextLevel.min - state.totalRedemptions;
            if (levelProgress) levelProgress.textContent = `${state.totalRedemptions}/${nextLevel.min} to ${levelData.next}`;
          } else {
            if (levelProgress) levelProgress.textContent = 'MAX LEVEL';
          }
        }

        // Update dashboard level display
        const dashboardIcon = document.getElementById('dashboard-level-icon');
        const dashboardName = document.getElementById('dashboard-level-name');
        const dashboardFill = document.getElementById('dashboard-progress-fill');
        const dashboardText = document.getElementById('dashboard-progress-text');
        
        if (dashboardIcon) dashboardIcon.textContent = levelData.icon;
        if (dashboardName) dashboardName.textContent = currentLevel;
        
        if (levelData.next) {
          const nextLevel = levels[levelData.next];
          const progress = ((state.totalRedemptions - levelData.min) / (nextLevel.min - levelData.min)) * 100;
          if (dashboardFill) dashboardFill.style.width = `${Math.min(progress, 100)}%`;
          if (dashboardText) dashboardText.textContent = `${state.totalRedemptions} of ${nextLevel.min} redemptions to reach ${levelData.next}`;
        } else {
          if (dashboardFill) dashboardFill.style.width = '100%';
          if (dashboardText) dashboardText.textContent = 'Maximum level achieved';
        }

        // Update account level display
        const profileIcon = document.getElementById('profile-level-icon');
        const profileName = document.getElementById('profile-level-name');
        const accountFill = document.getElementById('account-progress-fill');
        const accountText = document.getElementById('account-progress-text');
        
        if (profileIcon) profileIcon.textContent = levelData.icon;
        if (profileName) profileName.textContent = currentLevel;
        
        if (levelData.next) {
          const nextLevel = levels[levelData.next];
          const progress = ((state.totalRedemptions - levelData.min) / (nextLevel.min - levelData.min)) * 100;
          if (accountFill) accountFill.style.width = `${Math.min(progress, 100)}%`;
          if (accountText) accountText.textContent = `${state.totalRedemptions} of ${nextLevel.min} redemptions to reach ${levelData.next}`;
        } else {
          if (accountFill) accountFill.style.width = '100%';
          if (accountText) accountText.textContent = 'Maximum level achieved';
        }

        state.currentLevel = currentLevel;
      }

      function updateNavButtons() {
        const buttons = $$('nav button[data-screen]');
        buttons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.screen === state.currentScreen);
  });

      }

      function showScreen(name) {
        if (!state.authed && name !== "welcome") return; // block nav when not authed
        
        state.currentScreen = name;
        
        ["welcome","dashboard","account","messages"].forEach(s => {
          const el = $("#"+s+"-screen");
          if (el) el.hidden = s !== name;
        });
        
        updateNavButtons();
        
        if (name === "dashboard") renderOffers();
      }

      function initAccess() {
        console.log("Starting initAccess...");
        const form = document.getElementById("registration-form");
        const email = document.getElementById("email");
        const code = document.getElementById("accesscode");
        const btn = document.getElementById("access-btn");
        
        console.log("Form elements found:", { form: !!form, email: !!email, code: !!code, btn: !!btn });
        
        const validate = () => {
          if (!email || !code || !btn) {
            console.log("Missing form elements in validate");
            return;
          }
          const emailValue = email.value.trim();
          const codeValue = code.value.trim();
          const isValid = emailValue.includes("@") && codeValue.length > 0;
          
          console.log("Validation:", { emailValue, codeValue, isValid });
          
          if (isValid) {
            btn.disabled = false;
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            btn.classList.remove("disabled");
          } else {
            btn.disabled = true;
            btn.style.opacity = "0.5";
            btn.style.cursor = "not-allowed";
            btn.classList.add("disabled");
          }
        };
        
        if (email) {
          email.addEventListener("input", () => {
            console.log("Email input changed:", email.value);
            validate();
          });
        }
        if (code) {
          code.addEventListener("input", () => {
            console.log("Code input changed:", code.value);
            validate();
          });
        }
        
        if (form) {
          form.addEventListener("submit", (e) => {
            e.preventDefault();
            console.log("Form submitted, button disabled:", btn ? btn.disabled : "btn not found");
            if (!btn || btn.disabled) return;
            
            // authenticate UX
            state.authed = true;
            document.body.classList.add("authed");

            state.email = email ? email.value.trim() : "";
            const access = code ? code.value.trim() : "";
            if (access) state.codes.push(access);

            const mappedHotel = mapCodeToHotel(access);
            if (mappedHotel) state.scannedHotels.add(mappedHotel);

            populateHotelFilter();
            updateProfilePanel();
            updateLevelDisplay();
            showScreen("dashboard");
          });
        }
        
        // Initial validation
        setTimeout(validate, 100); // Small delay to ensure DOM is ready
        showScreen("welcome");
      }

      function updateProfilePanel() {
        const pEmail = document.getElementById("profile-email"); 
        if (pEmail) pEmail.textContent = state.email || "â€”";
        const pCodes = document.getElementById("profile-codes"); 
        if (pCodes) pCodes.textContent = state.codes.length ? state.codes.join(", ") : "â€”";
      }

      function mapCodeToHotel(code) {
        const h = (code || "").toUpperCase();
        if (h.includes("MARRIOTT") || h.startsWith("MA-")) return "Marriott";
        if (h.includes("HILTON")   || h.startsWith("HL-")) return "Hilton";
        if (h.includes("RITZ")     || h.startsWith("RZ-")) return "Ritz-Carlton";
        return null;
      }

      function populateHotelFilter() {
        // build available hotel set from catalog first
        state.availableHotels = new Set(catalog.map(o => o.hotel));

        const select = document.getElementById("hotel-filter");
        if (!select) return;
        select.innerHTML = "";

        // All hotels option
        const optAll = document.createElement("option");
        optAll.value = "ALL";
        optAll.textContent = "All Hotels";
        select.appendChild(optAll);

        // User scanned first, then others
        const userHotels = Array.from(state.scannedHotels);
        const others = Array.from(state.availableHotels).filter(h => !state.scannedHotels.has(h));

        [...userHotels, ...others].forEach(h => {
          const opt = document.createElement("option");
          opt.value = h; opt.textContent = h;
          select.appendChild(opt);
        });

        // Default selection: All Hotels
        select.value = "ALL";
      }

      function addHotelFromCode() {
        const box = document.getElementById("add-code");
        const val = box?.value.trim() || "";
        if (!val) return;
        const mapped = mapCodeToHotel(val);
        if (mapped) {
          state.scannedHotels.add(mapped);
          state.codes.push(val);
          populateHotelFilter();
          renderOffers();
          updateProfilePanel();
          alert(`Added offers from ${mapped}.`);
          box.value = "";
        } else {
          alert("Code not recognized. Include MA-/MARRIOTT-, HL-/HILTON-, or RZ-/RITZ- in the code.");
        }
      }

      function ensureOfferCodes() {
        // Attach a stable pseudo-unique code for each offer instance (per session)
        if (!ensureOfferCodes._map) ensureOfferCodes._map = new Map();
        const map = ensureOfferCodes._map;
        const getCodeFor = (offer) => {
          if (map.has(offer.id)) return map.get(offer.id);
          const prefix = (offer.hotel === "Marriott" ? "MH" : offer.hotel === "Hilton" ? "HL" : "RZ");
          const brand = offer.brand.replace(/[^A-Z]/gi, "").slice(0,3).toUpperCase();
          const rand = Math.random().toString(36).replace(/[^a-z0-9]/gi,'').slice(2,8).toUpperCase();
          const code = `${prefix}-${brand}-${rand}`;
          map.set(offer.id, code);
          return code;
        };
        return getCodeFor;
      }

      function renderOffers() {
        const grid = $("#offers-grid");
        const empty = $("#no-offers");
        const filter = $("#hotel-filter")?.value || "ALL";
        if (!grid) return;
        grid.innerHTML = "";

        let data;
        if (filter === "ALL") {
          // union of all unlocked hotels; if none scanned, show full catalog
          data = state.scannedHotels.size ?
            catalog.filter(o => state.scannedHotels.has(o.hotel)) :
            catalog.slice();
        } else {
          data = catalog.filter(o => o.hotel === filter);
        }

        if (!data.length) { empty.hidden = false; return; }
        empty.hidden = true;

        const codeFor = ensureOfferCodes(); // get code generator/lookup
        data.forEach(offer => {
          const displayCode = codeFor(offer);
          const card = document.createElement("div");
          card.className = "offer card";
          card.innerHTML = `
            <div class="brand">${offer.brand}</div>
            <div class="value">${offer.value}</div>
            <div class="muted small" style="margin-top:6px;">${offer.description}</div>
            <div class="source-chip pill">${offer.hotel}</div>
            <div class="muted small" style="margin-top:8px;">Offer code: <span class="code">${displayCode}</span></div>
          `;
          card.addEventListener("click", () => openOffer(offer.id, displayCode));
          grid.appendChild(card);
        });
      }

      function openOffer(id, displayCode) {
        const offer = catalog.find(o => o.id === id);
        if (!offer) return;
        let redeemHTML = "";

        if (offer.type === "qr") {
          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(offer.qrData || offer.brand)}`;
          redeemHTML = `
            <div style="text-align:center;margin:16px 0;">
              <img src="${qrUrl}" alt="QR Code" width="200" height="200" style="border-radius:10px;" />
            </div>
            <div class="foot">
              <button class="btn primary" type="button" onclick="App.markAsRedeemed()">Mark as Redeemed</button>
            </div>`;
        } else if (offer.type === "email") {
          redeemHTML = `
            <div>
              <label for="redeem-email">Email</label>
              <input id="redeem-email" type="email" placeholder="you@example.com"/>
            </div>
            <div class="foot">
              <button class="btn primary" type="button" onclick="App.submitEmail()">Submit Email</button>
            </div>`;
        } else {
          redeemHTML = `
            <div class="foot">
              <button class="btn primary" type="button" onclick="App.markAsRedeemed()">Mark as Used</button>
            </div>`;
        }

        const body = document.getElementById("modal-content-body");
        if (body) {
          body.innerHTML = `
            <div style="display:flex; align-items:baseline; justify-content:space-between; gap:12px; flex-wrap:wrap;">
              <div>
                <div class="muted small">Brand</div>
                <div style="font-weight:600; letter-spacing:.08em;">${offer.brand}</div>
              </div>
              <div class="pill">${offer.hotel}</div>
              <div class="value" style="font-weight:700;">${offer.value}</div>
            </div>
            <div class="divider"></div>
            <div class="muted" style="line-height:1.6;">${offer.description}</div>
            <div class="divider"></div>
            <div class="muted small">Offer code: <span class="code">${displayCode}</span></div>
            <div class="divider"></div>
            <div class="muted small">${offer.redemption}</div>
            ${redeemHTML}`;
        }
        setModalVisible("#offer-modal", true);
      }

      function markAsRedeemed() {
        const oldLevel = state.currentLevel;
        state.totalRedemptions += 1;
        const newLevel = getCurrentLevel(state.totalRedemptions);
        
        const totalEl = $("#total-redemptions");
        if (totalEl) totalEl.textContent = String(state.totalRedemptions);
        
        updateLevelDisplay();
        
        if (oldLevel !== newLevel) {
          setTimeout(() => {
            alert(`ðŸŽ‰ Congratulations! You've reached ${newLevel} level!`);
          }, 100);
        } else {
          alert("Offer redeemed successfully!");
        }
        
        setModalVisible("#offer-modal", false);
      }

      function submitEmail() {
        const input = document.getElementById("redeem-email");
        if (input && input.value.includes("@")) {
          const oldLevel = state.currentLevel;
          state.totalRedemptions += 1;
          const newLevel = getCurrentLevel(state.totalRedemptions);
          
          const totalEl = $("#total-redemptions");
          if (totalEl) totalEl.textContent = String(state.totalRedemptions);
          
          updateLevelDisplay();
          
          if (oldLevel !== newLevel) {
            setTimeout(() => {
              alert(`ðŸŽ‰ Level up! You've reached ${newLevel} level! Email submitted successfully!`);
            }, 100);
          } else {
            alert("Email submitted successfully!");
          }
          
          setModalVisible("#offer-modal", false);
        } else { 
          alert("Please enter a valid email address."); 
        }
      }

      // Messages
      function openMessage(id) {
        const msg = messages[id];
        const body = document.getElementById("message-content-body");
        if (msg && body) {
          body.innerHTML = `<div style="margin-bottom:8px;font-weight:600">${msg.subject}</div>
                            <div class="muted small" style="margin-bottom:12px;">${msg.sender} â€¢ ${msg.time}</div>
                            <div>${msg.content}</div>`;
          setModalVisible("#message-modal", true);
        }
      }
      function closeMessage() { setModalVisible("#message-modal", false); }

      // Levels modal
      function openLevels() { setModalVisible("#levels-modal", true); }
      function closeLevels() { setModalVisible("#levels-modal", false); }

      // Account details
      function openAccountDetail(type) {
        let content = "";
        if (type === "profile") {
          const levelData = levels[state.currentLevel];
          content = `
            <div class="muted small">Email</div>
            <div>${state.email || "â€”"}</div>
            <div class="divider"></div>
            <div class="muted small">Current Level</div>
            <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
              <span style="font-size: 1.2rem;">${levelData.icon}</span>
              <span style="font-weight: 600;">${state.currentLevel}</span>
            </div>
            <div class="divider"></div>
            <div class="muted small">Access Codes</div>
            <div class="code">${state.codes.join(", ") || "â€”"}</div>
          `;
        } else if (type === "history") {
          const levelData = levels[state.currentLevel];
          content = `
            <div class="muted small">Total Redemptions</div>
            <div>${state.totalRedemptions}</div>
            <div class="divider"></div>
            <div class="muted small">Current Level</div>
            <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
              <span style="font-size: 1.2rem;">${levelData.icon}</span>
              <span style="font-weight: 600;">${state.currentLevel}</span>
            </div>
            <div class="divider"></div>
            <div class="muted small">Progress to Next Level</div>
            <div style="margin: 8px 0;">
              <div class="level-progress-bar">
                <div class="level-progress-fill" style="width: ${levelData.next ? ((state.totalRedemptions - levelData.min) / (levels[levelData.next].min - levelData.min)) * 100 : 100}%;"></div>
              </div>
              <div class="level-text">${levelData.next ? `${state.totalRedemptions} of ${levels[levelData.next].min} to reach ${levelData.next}` : 'Maximum level achieved'}</div>
            </div>
          `;
        } else { 
          content = `<div class="muted">Content not found.</div>`; 
        }
        const body = document.getElementById("account-detail-body"); 
        if (body) body.innerHTML = content;
        setModalVisible("#account-detail-modal", true);
      }
      function closeAccountDetail() { setModalVisible("#account-detail-modal", false); }

      // Modal helper
      function setModalVisible(selector, visible) {
        const el = document.querySelector(selector);
        if (!el) return;
        el.setAttribute("aria-hidden", visible ? "false" : "true");
      }

      document.addEventListener("DOMContentLoaded", () => {
        // clicking overlay closes modals
      $$(".modal").forEach(m => m.addEventListener("click", (e) => { 
      if (e.target === m) m.setAttribute("aria-hidden","true"); 
     }));


        initAccess();           // start on Access
        populateHotelFilter();  // prep filter options
        renderOffers();         // render (will respect auth and filters)
        updateLevelDisplay();   // initialize level display
      });

      return {
        showScreen,
        openOffer, closeOffer: () => setModalVisible("#offer-modal", false),
        markAsRedeemed, submitEmail,
        openLevels, closeLevels,
        openAccountDetail, closeAccountDetail,
        openMessage, closeMessage,
        addHotelFromCode, renderOffers
      };
    })();
  </script>
</body>
</html>
